{% extends "base.html" %}

{% block title %}Book Requests{% endblock %}

{% block content %}
<div class="admin-layout">
  <nav class="admin-nav">
    <h3>Administration</h3>
    <ul>
      <li><a href="{{ url_for('admin.dashboard') }}">Dashboard</a></li>
      <li><a href="{{ url_for('admin.books') }}">Books</a></li>
      <li><a href="{{ url_for('admin.import_pdf_dashboard') }}">PDF Import</a></li>
      <li><a href="{{ url_for('admin.loans') }}">Loans</a></li>
      <li><a href="{{ url_for('admin.users') }}">Users</a></li>
      <li><a href="{{ url_for('admin.reading_lists') }}">Reading Lists</a></li>
      <li><a href="{{ url_for('admin.book_requests') }}" class="active">Requests{% if pending_count %} <span class="badge badge-gold">{{ pending_count }}</span>{% endif %}</a></li>
      <li><a href="{{ url_for('admin.audit') }}">Audit Log</a></li>
      <li><a href="{{ url_for('admin.reports') }}">Reports</a></li>
      <li><a href="{{ url_for('admin.change_password') }}">Change Password</a></li>
    </ul>
  </nav>

  <div class="admin-content">
    <h1>Book Requests</h1>

    <div class="mb-md">
      <a href="{{ url_for('admin.book_requests', status='pending') }}" class="btn btn-sm {% if status_filter == 'pending' %}btn-primary{% else %}btn-outline{% endif %}">Pending{% if pending_count %} ({{ pending_count }}){% endif %}</a>
      <a href="{{ url_for('admin.book_requests', status='approved') }}" class="btn btn-sm {% if status_filter == 'approved' %}btn-primary{% else %}btn-outline{% endif %}">Approved</a>
      <a href="{{ url_for('admin.book_requests', status='declined') }}" class="btn btn-sm {% if status_filter == 'declined' %}btn-primary{% else %}btn-outline{% endif %}">Declined</a>
      <a href="{{ url_for('admin.book_requests', status='fulfilled') }}" class="btn btn-sm {% if status_filter == 'fulfilled' %}btn-primary{% else %}btn-outline{% endif %}">Fulfilled</a>
      <a href="{{ url_for('admin.book_requests', status='all') }}" class="btn btn-sm {% if status_filter == 'all' %}btn-primary{% else %}btn-outline{% endif %}">All</a>
    </div>

    <table class="admin-table">
      <thead>
        <tr>
          <th>Patron</th>
          <th>Requested Title</th>
          <th>Author</th>
          <th>Reason</th>
          <th>Submitted</th>
          <th>Status</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for req in requests %}
          <tr>
            <td>
              <a href="{{ url_for('admin.user_detail', user_id=req.user.id) }}">{{ req.user.display_name }}</a>
              <br><small class="text-subdued">{{ req.user.email }}</small>
            </td>
            <td><strong>{{ req.title }}</strong></td>
            <td>{{ req.author or '&mdash;'|safe }}</td>
            <td class="td-truncate" title="{{ req.reason or '' }}">
              {{ req.reason or '&mdash;'|safe }}
            </td>
            <td>{{ req.created_at.strftime('%Y-%m-%d') }}</td>
            <td>
              {% if req.status == 'pending' %}
                <span class="badge badge-gold">Pending</span>
              {% elif req.status == 'approved' %}
                <span class="badge badge-success">Approved</span>
              {% elif req.status == 'declined' %}
                <span class="badge badge-danger">Declined</span>
              {% elif req.status == 'fulfilled' %}
                <span class="badge badge-fulfilled">Fulfilled</span>
              {% else %}
                <span class="badge">{{ req.status|capitalize }}</span>
              {% endif %}
            </td>
            <td>
              {% if req.status == 'pending' %}
              <details class="details-dropdown">
                <summary class="btn btn-sm btn-primary">Resolve</summary>
                <div class="details-dropdown-panel">
                  <form method="post" action="{{ url_for('admin.book_request_resolve', request_id=req.id) }}">
                    {{ resolve_form.hidden_tag() }}
                    <div class="form-group">
                      <label class="form-label">Decision</label>
                      <select name="status" class="form-control">
                        <option value="approved">Approved</option>
                        <option value="declined">Declined</option>
                        <option value="fulfilled">Fulfilled</option>
                      </select>
                    </div>
                    <div class="form-group">
                      <label class="form-label">Notes</label>
                      <textarea name="admin_notes" rows="2" class="form-control" placeholder="Notes for the patron (optional)"></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary btn-sm">Submit</button>
                  </form>
                </div>
              </details>
              {% else %}
                {% if req.admin_notes %}
                  <span title="{{ req.admin_notes }}" class="text-dotted">View notes</span>
                {% else %}
                  &mdash;
                {% endif %}
              {% endif %}
            </td>
          </tr>
        {% else %}
          <tr>
            <td colspan="7">No book requests found.</td>
          </tr>
        {% endfor %}
      </tbody>
    </table>

    {% if pagination.pages > 1 %}
      <nav class="pagination">
        {% if pagination.has_prev %}
          <a href="{{ url_for('admin.book_requests', page=pagination.prev_num, status=status_filter) }}">&laquo; Previous</a>
        {% endif %}
        <span>Page {{ pagination.page }} of {{ pagination.pages }}</span>
        {% if pagination.has_next %}
          <a href="{{ url_for('admin.book_requests', page=pagination.next_num, status=status_filter) }}">Next &raquo;</a>
        {% endif %}
      </nav>
    {% endif %}
  </div>
</div>
{% endblock %}
