{% extends "base.html" %}

{% block title %}PDF Import{% endblock %}

{% block content %}
<div class="admin-layout">
  <nav class="admin-nav">
    <h3>Administration</h3>
    <ul>
      <li><a href="{{ url_for('admin.dashboard') }}">Dashboard</a></li>
      <li><a href="{{ url_for('admin.books') }}">Books</a></li>
      <li><a href="{{ url_for('admin.import_pdf_dashboard') }}" class="active">PDF Import</a></li>
      <li><a href="{{ url_for('admin.loans') }}">Loans</a></li>
      <li><a href="{{ url_for('admin.users') }}">Users</a></li>
      <li><a href="{{ url_for('admin.reading_lists') }}">Reading Lists</a></li>
      <li><a href="{{ url_for('admin.book_requests') }}">Requests</a></li>
      <li><a href="{{ url_for('admin.audit') }}">Audit Log</a></li>
      <li><a href="{{ url_for('admin.reports') }}">Reports</a></li>
      <li><a href="{{ url_for('admin.change_password') }}">Change Password</a></li>
    </ul>
  </nav>

  <div class="admin-content">
    <h1>PDF Import</h1>

    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        {% for category, message in messages %}
          <div class="alert alert-{{ category }}">{{ message }}</div>
        {% endfor %}
      {% endif %}
    {% endwith %}

    <!-- Staging Stats -->
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-value">{{ staging_file_count }}</div>
        <div class="stat-label">PDFs in Staging</div>
      </div>
      <div class="stat-card">
        <div class="stat-value">{{ "%.1f"|format(staging_size_gb) }} GB</div>
        <div class="stat-label">Staging Size</div>
      </div>
      <div class="stat-card">
        <div class="stat-value">{{ pending_count }}</div>
        <div class="stat-label">Pending Review</div>
      </div>
      <div class="stat-card">
        <div class="stat-value">{{ approved_count }}</div>
        <div class="stat-label">Approved</div>
      </div>
    </div>

    <!-- Upload PDFs -->
    <div class="card mb-xl">
      <div class="card-body">
        <h3>Upload PDFs</h3>
        <p class="text-subdued mb-md" style="font-size: 0.9rem;">
          Drag-and-drop PDF files or click the area below to select them. Files are placed in the staging directory for scanning.
        </p>

        <form id="upload-form" method="POST" action="{{ url_for('admin.import_pdf_upload') }}" enctype="multipart/form-data">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
          <input type="file" id="pdf-file-input" name="pdf_files" multiple accept=".pdf" class="d-none">

          <div id="drop-zone" class="drop-zone">
            <p class="drop-zone-text">
              <strong>Drop PDF files here</strong><br>
              or click to browse
            </p>
            <p class="drop-zone-hint">
              Max 100 MB per file &middot; PDF only
            </p>
          </div>

          <div id="file-list" class="mt-md d-none"></div>

          <button type="submit" id="upload-btn" class="btn btn-primary mt-md d-none">
            Upload
          </button>
        </form>
      </div>
    </div>

    <!-- Scan Controls -->
    <div class="card mb-xl">
      <div class="card-body">
        <h3>Scan Staging Directory</h3>
        <p class="text-subdued mb-md" style="font-size: 0.9rem;">
          After uploading (or adding files via SCP/rsync), click "Start Scan" to extract metadata and queue them for review.
        </p>

        <div id="scan-controls">
          <form method="POST" action="{{ url_for('admin.import_pdf_scan') }}" class="d-inline">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <button type="submit" class="btn btn-primary" id="scan-btn" {% if scan_progress.running %}disabled{% endif %}>
              {% if scan_progress.running %}Scanning...{% else %}Start Scan{% endif %}
            </button>
          </form>
          {% if pending_count > 0 %}
            <a href="{{ url_for('admin.import_pdf_review') }}" class="btn btn-secondary" style="margin-left: 0.5rem;">
              Review Queue ({{ pending_count }})
            </a>
          {% endif %}
        </div>

        <!-- Progress Bar (shown during scan) -->
        <div id="scan-progress" class="mt-lg" {% if not scan_progress.running %}style="display: none;"{% endif %}>
          <div class="flex-between mb-sm" style="font-size: 0.85rem; color: #5c534d;">
            <span id="progress-label">Processing...</span>
            <span id="progress-count">0 / 0</span>
          </div>
          <div class="progress-bar-track">
            <div class="progress-bar-fill" id="progress-fill" style="width: 0%;"></div>
          </div>
          <p id="progress-current" class="mt-sm text-subdued text-xs text-break"></p>
        </div>
      </div>
    </div>

    <!-- AI Extraction Status -->
    <div class="card mb-xl">
      <div class="card-body">
        <h3 class="flex-center gap-sm">
          AI Metadata Extraction
          {% if config.AI_EXTRACTION_ENABLED %}
            <span class="badge badge-gold">Active</span>
          {% else %}
            <span class="badge badge-secondary">Disabled</span>
          {% endif %}
        </h3>
        {% if config.AI_EXTRACTION_ENABLED %}
          <p style="color: #5c534d; font-size: 0.9rem;" class="mb-sm">
            Claude AI reads the first pages of each PDF to extract title, author, year, ISBN, language, and subject tags.
            {% if config.AI_EXTRACTION_TIER == 'tier3' %}
              Running in <strong>Tier 3 (deep read)</strong> mode — first 25 pages with rich descriptions.
            {% elif config.AI_EXTRACTION_TIER == 'tier2' %}
              Running in <strong>Tier 2</strong> mode — metadata + catalog descriptions.
            {% else %}
              Running in <strong>Tier 1</strong> mode — metadata only.
            {% endif %}
          </p>
          <p class="text-subdued text-xs">
            AI-extracted fields have the highest priority in the merge pipeline. Books processed with AI show a gold badge in the review queue.
          </p>
        {% else %}
          <p class="text-subdued" style="font-size: 0.9rem;">
            Set <code>AI_EXTRACTION_ENABLED=true</code> and provide an <code>ANTHROPIC_API_KEY</code> in the server <code>.env</code> to enable Claude-powered metadata extraction.
          </p>
        {% endif %}
      </div>
    </div>

    <!-- Instructions -->
    <div class="card">
      <div class="card-body">
        <h3>How It Works</h3>
        <ol style="line-height: 2; color: #5c534d;">
          <li><strong>Stage</strong> — Upload PDFs using the form above, or transfer files via SCP/rsync</li>
          <li><strong>Scan</strong> — Click "Start Scan" to extract metadata from each PDF</li>
          <li><strong>Review</strong> — Check extracted metadata, edit as needed, flag duplicates</li>
          <li><strong>Import</strong> — Approve individually or in bulk to add to the library catalog</li>
        </ol>
      </div>
    </div>
  </div>
</div>

<script>
(function() {
  var dropZone = document.getElementById('drop-zone');
  var fileInput = document.getElementById('pdf-file-input');
  var fileList = document.getElementById('file-list');
  var uploadBtn = document.getElementById('upload-btn');
  var uploadForm = document.getElementById('upload-form');
  var selectedFiles = [];

  function formatSize(bytes) {
    if (bytes < 1024) return bytes + ' B';
    if (bytes < 1048576) return (bytes / 1024).toFixed(1) + ' KB';
    return (bytes / 1048576).toFixed(1) + ' MB';
  }

  function renderFileList() {
    if (selectedFiles.length === 0) {
      fileList.classList.add('d-none');
      uploadBtn.classList.add('d-none');
      return;
    }
    fileList.classList.remove('d-none');
    uploadBtn.classList.remove('d-none');

    var html = '';
    for (var i = 0; i < selectedFiles.length; i++) {
      var f = selectedFiles[i];
      var valid = f.name.toLowerCase().endsWith('.pdf');
      html += '<div class="file-list-item' + (valid ? '' : ' file-list-item--invalid') + '">';
      html += '<span class="text-break">' + f.name + ' <span class="text-subdued">(' + formatSize(f.size) + ')</span>';
      if (!valid) html += ' <span class="text-error">&mdash; not a PDF</span>';
      html += '</span>';
      html += '<button type="button" data-index="' + i + '" class="file-list-remove" title="Remove">&times;</button>';
      html += '</div>';
    }
    fileList.innerHTML = html;

    var removeBtns = fileList.querySelectorAll('button[data-index]');
    for (var j = 0; j < removeBtns.length; j++) {
      removeBtns[j].addEventListener('click', function() {
        selectedFiles.splice(parseInt(this.getAttribute('data-index')), 1);
        syncInputFiles();
        renderFileList();
      });
    }

    uploadBtn.textContent = 'Upload ' + selectedFiles.length + ' file' + (selectedFiles.length > 1 ? 's' : '');
  }

  function syncInputFiles() {
    var dt = new DataTransfer();
    for (var i = 0; i < selectedFiles.length; i++) {
      dt.items.add(selectedFiles[i]);
    }
    fileInput.files = dt.files;
  }

  function addFiles(files) {
    for (var i = 0; i < files.length; i++) {
      var dup = false;
      for (var j = 0; j < selectedFiles.length; j++) {
        if (selectedFiles[j].name === files[i].name && selectedFiles[j].size === files[i].size) {
          dup = true;
          break;
        }
      }
      if (!dup) selectedFiles.push(files[i]);
    }
    syncInputFiles();
    renderFileList();
  }

  dropZone.addEventListener('click', function() { fileInput.click(); });

  fileInput.addEventListener('change', function() {
    if (fileInput.files.length) addFiles(fileInput.files);
  });

  dropZone.addEventListener('dragover', function(e) {
    e.preventDefault();
    dropZone.classList.add('drop-zone--active');
  });

  dropZone.addEventListener('dragleave', function(e) {
    e.preventDefault();
    dropZone.classList.remove('drop-zone--active');
  });

  dropZone.addEventListener('drop', function(e) {
    e.preventDefault();
    dropZone.classList.remove('drop-zone--active');
    if (e.dataTransfer.files.length) addFiles(e.dataTransfer.files);
  });
})();
</script>

<script>
(function() {
  var running = {{ 'true' if scan_progress.running else 'false' }};
  if (!running) return;

  var progressDiv = document.getElementById('scan-progress');
  var progressLabel = document.getElementById('progress-label');
  var progressCount = document.getElementById('progress-count');
  var progressFill = document.getElementById('progress-fill');
  var progressCurrent = document.getElementById('progress-current');
  var scanBtn = document.getElementById('scan-btn');

  progressDiv.style.display = 'block';

  function poll() {
    fetch('{{ url_for("admin.import_pdf_scan_status") }}')
      .then(function(r) { return r.json(); })
      .then(function(data) {
        var pct = data.total > 0 ? Math.round((data.processed / data.total) * 100) : 0;
        progressFill.style.width = pct + '%';
        progressCount.textContent = data.processed + ' / ' + data.total;
        progressCurrent.textContent = data.current_file || '';

        if (data.running) {
          progressLabel.textContent = 'Scanning... (' + pct + '%)';
          setTimeout(poll, 1500);
        } else {
          progressLabel.textContent = 'Scan complete!';
          scanBtn.disabled = false;
          scanBtn.textContent = 'Start Scan';
          if (data.processed > 0) {
            setTimeout(function() { location.reload(); }, 1500);
          }
        }
      })
      .catch(function() {
        setTimeout(poll, 3000);
      });
  }

  poll();
})();
</script>
{% endblock %}
